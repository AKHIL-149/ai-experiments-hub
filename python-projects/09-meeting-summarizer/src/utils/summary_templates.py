"""Summary Templates - Custom summary formatting - Phase 5"""

import logging
from typing import Dict, Optional
from pathlib import Path
from jinja2 import Template, Environment, FileSystemLoader, TemplateNotFound
from datetime import datetime

logger = logging.getLogger(__name__)


class SummaryTemplateManager:
    """
    Manage custom summary templates

    Allows users to define custom formats for meeting summaries
    using Jinja2 templates.
    """

    DEFAULT_TEMPLATES = {
        'executive': """# Executive Summary - {{filename}}

**Date**: {{date}}
**Duration**: {{duration_minutes}} minutes
**Processing Time**: {{processing_time}} seconds

## Key Highlights

{{summary}}

## Critical Action Items ({{action_items|length}})
{% for action in action_items[:5] %}
- **{{action.description}}**
  - Assigned to: {{action.assignee}}
  - Priority: {{action.priority}}
  - Due: {{action.due_date}}
{% endfor %}

## Strategic Decisions
{% for decision in decisions %}
{{loop.index}}. {{decision.decision}}
   *Impact*: {{decision.impact}}
{% endfor %}

---
*Generated by Meeting Summarizer*
""",

        'detailed': """# Meeting Analysis Report

## Meeting Information
- **File**: {{filename}}
- **Date**: {{date}}
- **Duration**: {{duration_minutes}} minutes ({{duration_seconds}}s)
- **Format**: {{audio_format}}
- **Language**: {{language}}

## Processing Statistics
- **Processing Time**: {{processing_time}}s
- **Estimated Cost**: ${{cost}}
- **Cache Hits**: {{cache_hits}}
- **Transcription Backend**: {{transcription_backend}}
- **LLM Provider**: {{llm_provider}}

## Summary ({{summary_level}})

{{summary}}

## Key Topics Discussed ({{topics|length}})
{% for topic in topics %}
{{loop.index}}. {{topic}}
{% endfor %}

## Action Items ({{action_items|length}})
{% for action in action_items %}
### Action {{loop.index}}: {{action.description}}
- **Assignee**: {{action.assignee}}
- **Due Date**: {{action.due_date}}
- **Priority**: {{action.priority}}
- **Category**: {{action.category}}
- **Status**: {{action.status}}
{% endfor %}

## Decisions Made ({{decisions|length}})
{% for decision in decisions %}
### Decision {{loop.index}}
**What**: {{decision.decision}}

**Context**: {{decision.context}}

**Impact**: {{decision.impact}}
{% endfor %}

## Follow-up Items
{% for item in follow_ups %}
- {{item}}
{% endfor %}

---
**Report Generated**: {{timestamp}}
""",

        'brief': """# Quick Summary - {{filename}}

{{summary}}

**Topics**: {{topics|join(', ')}}

**Actions** ({{action_items|length}}):
{% for action in action_items %}
- {{action.description}} ({{action.assignee}})
{% endfor %}

*Generated {{date}}*
""",

        'meeting_minutes': """# Meeting Minutes

**Meeting Date**: {{date}}
**Duration**: {{duration_minutes}} minutes
**Attendees**: {{attendees|join(', ') if attendees else 'Not specified'}}

## Agenda Topics
{% for topic in topics %}
{{loop.index}}. {{topic}}
{% endfor %}

## Discussion Summary

{{summary}}

## Decisions
{% for decision in decisions %}
**{{loop.index}}.** {{decision.decision}}
- Context: {{decision.context}}
- Impact: {{decision.impact}}
{% endfor %}

## Action Items
| # | Action | Assigned To | Due Date | Priority |
|---|--------|-------------|----------|----------|
{% for action in action_items %}
| {{loop.index}} | {{action.description}} | {{action.assignee}} | {{action.due_date}} | {{action.priority}} |
{% endfor %}

## Next Steps
{% for item in follow_ups %}
- {{item}}
{% endfor %}

---
**Next Meeting**: TBD
**Prepared by**: Meeting Summarizer AI
""",

        'technical': """# Technical Meeting Report

## Metadata
```
File: {{filename}}
Date: {{date}}
Duration: {{duration_seconds}}s
Format: {{audio_format}}
Language: {{language}}
```

## Processing Pipeline
```
Transcription: {{transcription_backend}}
LLM: {{llm_provider}}
Model: {{llm_model}}
Cost: ${{cost}}
Time: {{processing_time}}s
Cache: {{cache_hits}} hits
```

## Analysis

### Summary
{{summary}}

### Topics Identified
```python
topics = [
{% for topic in topics %}
    "{{topic}}"{{ "," if not loop.last }}
{% endfor %}
]
```

### Action Items
```json
{
  "total": {{action_items|length}},
  "items": [
{% for action in action_items %}
    {
      "id": {{loop.index}},
      "description": "{{action.description}}",
      "assignee": "{{action.assignee}}",
      "priority": "{{action.priority}}",
      "due_date": "{{action.due_date}}",
      "category": "{{action.category}}"
    }{{ "," if not loop.last }}
{% endfor %}
  ]
}
```

### Decisions
{% for decision in decisions %}
{{loop.index}}. {{decision.decision}}
{% endfor %}

---
*Timestamp: {{timestamp}}*
"""
    }

    def __init__(self, custom_templates_dir: Optional[str] = None):
        """
        Initialize Template Manager

        Args:
            custom_templates_dir: Directory containing custom templates (optional)
        """
        self.custom_templates_dir = Path(custom_templates_dir) if custom_templates_dir else None

        # Setup Jinja2 environment
        if self.custom_templates_dir and self.custom_templates_dir.exists():
            self.env = Environment(loader=FileSystemLoader(str(self.custom_templates_dir)))
            logger.info(f"Loaded custom templates from {self.custom_templates_dir}")
        else:
            self.env = Environment()

    def render_summary(
        self,
        template_name: str,
        analysis_result: Dict,
        custom_data: Optional[Dict] = None
    ) -> str:
        """
        Render summary using specified template

        Args:
            template_name: Name of template to use (executive, detailed, brief, etc.)
            analysis_result: Full analysis result dictionary
            custom_data: Additional custom data to pass to template

        Returns:
            Rendered summary text
        """
        # Prepare template context
        context = self._prepare_context(analysis_result)

        if custom_data:
            context.update(custom_data)

        try:
            # Try to load custom template first
            if self.custom_templates_dir:
                try:
                    template = self.env.get_template(f"{template_name}.md")
                    logger.info(f"Using custom template: {template_name}")
                    return template.render(**context)
                except TemplateNotFound:
                    pass

            # Fallback to default templates
            if template_name in self.DEFAULT_TEMPLATES:
                template = Template(self.DEFAULT_TEMPLATES[template_name])
                logger.info(f"Using default template: {template_name}")
                return template.render(**context)

            # If template not found, use standard template
            logger.warning(f"Template '{template_name}' not found, using 'detailed'")
            template = Template(self.DEFAULT_TEMPLATES['detailed'])
            return template.render(**context)

        except Exception as e:
            logger.error(f"Template rendering failed: {str(e)}")
            return self._generate_fallback_summary(analysis_result)

    def _prepare_context(self, analysis_result: Dict) -> Dict:
        """Prepare template context from analysis result"""
        # Extract data from analysis result
        summary = analysis_result.get('summary', {})
        actions = analysis_result.get('actions', {})
        metadata = analysis_result.get('metadata', {})
        stats = analysis_result.get('statistics', {})

        context = {
            # Metadata
            'filename': metadata.get('filename', 'Unknown'),
            'date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'timestamp': datetime.now().isoformat(),
            'duration_seconds': metadata.get('duration_seconds', 0),
            'duration_minutes': round(metadata.get('duration_seconds', 0) / 60, 1),
            'audio_format': metadata.get('format', 'unknown'),
            'language': analysis_result.get('transcript', {}).get('language', 'en'),

            # Summary
            'summary': summary.get('text', 'No summary available'),
            'summary_level': summary.get('level', 'standard'),

            # Topics
            'topics': analysis_result.get('topics', []),

            # Actions
            'action_items': actions.get('action_items', []),
            'decisions': actions.get('decisions', []),
            'follow_ups': actions.get('follow_ups', []),

            # Statistics
            'processing_time': round(stats.get('processing_time_seconds', 0), 1),
            'cost': format(stats.get('total_cost_usd', 0), '.4f'),
            'cache_hits': stats.get('cache_hits', 0),
            'transcription_backend': stats.get('transcription_backend', 'unknown'),
            'llm_provider': stats.get('llm_provider', 'unknown'),
            'llm_model': stats.get('llm_model', 'unknown'),

            # Optional
            'attendees': metadata.get('attendees', [])
        }

        return context

    def _generate_fallback_summary(self, analysis_result: Dict) -> str:
        """Generate simple fallback summary if template rendering fails"""
        summary = analysis_result.get('summary', {}).get('text', 'No summary available')
        topics = analysis_result.get('topics', [])
        actions = analysis_result.get('actions', {}).get('action_items', [])

        fallback = f"""# Meeting Summary

{summary}

## Topics
{', '.join(topics) if topics else 'None'}

## Action Items ({len(actions)})
"""
        for i, action in enumerate(actions, 1):
            fallback += f"{i}. {action.get('description', 'N/A')}\n"

        return fallback

    def list_available_templates(self) -> Dict[str, str]:
        """
        List all available templates

        Returns:
            Dictionary mapping template names to descriptions
        """
        templates = {
            'executive': 'Executive summary with highlights and critical actions',
            'detailed': 'Comprehensive report with full details',
            'brief': 'Quick summary with topics and actions',
            'meeting_minutes': 'Formal meeting minutes format',
            'technical': 'Technical format with JSON and metadata'
        }

        # Add custom templates
        if self.custom_templates_dir and self.custom_templates_dir.exists():
            for template_file in self.custom_templates_dir.glob('*.md'):
                template_name = template_file.stem
                if template_name not in templates:
                    templates[template_name] = f'Custom template: {template_name}'

        return templates

    def save_custom_template(self, name: str, template_content: str):
        """
        Save a custom template

        Args:
            name: Template name
            template_content: Jinja2 template content
        """
        if not self.custom_templates_dir:
            self.custom_templates_dir = Path('./templates/custom')

        self.custom_templates_dir.mkdir(parents=True, exist_ok=True)

        template_file = self.custom_templates_dir / f"{name}.md"
        template_file.write_text(template_content, encoding='utf-8')

        logger.info(f"Saved custom template: {name}")

        # Reload environment
        self.env = Environment(loader=FileSystemLoader(str(self.custom_templates_dir)))
